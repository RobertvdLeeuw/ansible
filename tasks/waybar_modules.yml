---
# Build and install custom waybar modules (workspaces and resources)

- name: "Install dependencies for waybar modules"
  apt:
    name:
      - lm-sensors
      - jq
    state: present
  become: yes

- name: "Check if workspaces module is already built"
  stat:
    path: "{{ playbook_dir }}/waybar_modules/workspaces/target/release/workspaces"
  register: workspaces_binary

- name: "Build workspaces module"
  shell: cargo build --release
  args:
    chdir: "{{ playbook_dir }}/waybar_modules/workspaces"
  when: not workspaces_binary.stat.exists

- name: "Install workspaces module to /usr/local/bin"
  copy:
    src: "{{ playbook_dir }}/waybar_modules/workspaces/target/release/workspaces"
    dest: /usr/local/bin/workspaces
    mode: '0755'
    remote_src: yes
  become: yes

- name: "Check if resources module is already built"
  stat:
    path: "{{ playbook_dir }}/waybar_modules/resources/target/release/resources"
  register: resources_binary

- name: "Build resources module"
  shell: cargo build --release
  args:
    chdir: "{{ playbook_dir }}/waybar_modules/resources"
  when: not resources_binary.stat.exists

- name: "Install resources module to /usr/local/bin"
  copy:
    src: "{{ playbook_dir }}/waybar_modules/resources/target/release/resources"
    dest: /usr/local/bin/resources
    mode: '0755'
    remote_src: yes
  become: yes

- name: "Detect hardware sensors"
  shell: yes | sensors-detect
  become: yes
  register: sensors_detect
  changed_when: false
  failed_when: false

- name: "Display sensor detection note"
  debug:
    msg: |
      Sensors have been configured. You may need to customize the sensor paths
      in waybar_modules/resources/src/main.rs for your specific hardware.

      To find your sensor paths:
      1. Run: sensors -j | jq '.'
      2. Update lines 73 and 95 in waybar_modules/resources/src/main.rs
      3. Rebuild: cd waybar_modules/resources && cargo build --release
      4. Reinstall: sudo cp target/release/resources /usr/local/bin/

      GPU Monitoring:
      - AMD GPUs: Install rocm-smi (sudo apt install rocm-smi)
      - NVIDIA GPUs: Code needs modification to use nvidia-smi instead
      - See waybar_modules/README.md for NVIDIA instructions

