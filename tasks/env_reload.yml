---
# Reload environment variables from encrypted .env file

- name: "Check if .env file exists"
  stat:
    path: "{{ playbook_dir }}/.env"
  register: env_file

- name: "Check if SOPS is installed"
  command: which sops
  register: sops_check
  changed_when: false
  failed_when: false

- name: "Verify .env can be decrypted"
  shell: sops -d {{ playbook_dir }}/.env > /dev/null 2>&1
  register: decrypt_check
  changed_when: false
  failed_when: false
  when: env_file.stat.exists and sops_check.rc == 0

- name: "Display reload instructions"
  debug:
    msg: |
      Environment variables are loaded automatically when you start a new shell.
      
      To reload in current shell:
      - Zsh:  source ~/.zshrc  (or use alias: env-reload)
      - Bash: source ~/.bashrc (or use alias: env-reload)
      
      To verify variables are loaded:
      - echo $OPENAI_API_KEY
      - echo $HOMELAB_IP
      
      To edit .env:
      - ~/ansible/scripts/env-helper.sh edit (or use alias: env-edit)
      
      To view .env:
      - ~/ansible/scripts/env-helper.sh view (or use alias: env-view)
  when: env_file.stat.exists and decrypt_check.rc == 0

- name: "Warning: .env file not found"
  debug:
    msg: |
      WARNING: .env file not found at {{ playbook_dir }}/.env
      
      To create it:
      1. cd {{ playbook_dir }}
      2. ./scripts/env-helper.sh init
      3. ./scripts/env-helper.sh edit
  when: not env_file.stat.exists

- name: "Warning: Cannot decrypt .env"
  debug:
    msg: |
      WARNING: Cannot decrypt .env file
      
      Possible issues:
      1. SOPS not installed (run: ansible-playbook playbook.yml --tags foundation -K)
      2. Age key missing (restore from backup to ~/.config/sops/age/keys.txt)
      3. .env not encrypted (run: ~/ansible/scripts/env-helper.sh encrypt)
      
      To verify:
      - Check SOPS: which sops
      - Check age key: ls -la ~/.config/sops/age/keys.txt
      - Test decrypt: sops -d {{ playbook_dir }}/.env
  when: env_file.stat.exists and (sops_check.rc != 0 or decrypt_check.rc != 0)

